<script>
  import {Card,Container,Pane,Button,Icon,Field} from 'malina-ui';
  import {mdiCircle, mdiSend} from '@mdi/js';
  import {Route} from 'malinajs-router';
  import {sockets,makeSocketStore} from '@/stores/sockets';

  import Request from '@/app/Request';
  import Saved from '@/app/Saved';
  import Editor from '@/app/Editor';
  import ModeSwitcher from '@/app/cmp/ModeSwitcher';
  import {modes} from '@/lib/modes';

  export let id;

  let online = false;
  let info;
  let requests = [];
  let editorMode = 'hex';
  let editorValue = [];

  const socket = makeSocketStore(id);

  $onMount(()=>socket.status.$$( params => {
    online = !!params;
    if(online && !info) info = {
      ip: params.ip,
      num: params.num,
    }
  }));

  $onMount(()=>socket.$$( data => {
    requests = data;
  }));

  let sending = false;
  async function send(){
    sending = true;
    await socket.send(editorValue);
    editorValue=[];
    sending = false;
  }

  function scrollToDown(el,param){

    let preventScroll = false;
    function handler(e){
      preventScroll = el.scrollHeight > el.scrollTop+el.clientHeight+10;
    }

    el.addEventListener('scroll',handler);
    return {
      async update(p){
        await $tick();
        await $tick();
        !preventScroll && el.scroll({top: el.scrollHeight, behavior: 'smooth'})
      },
      destroy(){
        el.removeEventListener('scroll',handler);
      }
    }
  }

</script>

{#if info}
  <Pane row>
    <Pane col>
      <Pane row size="5" class="top">
        <div class="status">
          {#if info}
            <Icon src={mdiCircle} color="var(--color-{online ? 'success' : 'error'})" size="0.7"/>
            Connection #{info.num}
            <span>
              {info.ip}
            </span>
          {/if}
        </div>
      </Pane>
      <Pane col>
        <div class="requests" #dv *scrollToDown={requests}>
        {#each requests as request}
          <Request data={request.data} type={request.type}/>
        {/each}
        </div>
      </Pane>
    </Pane>
    {#if online}
      <Pane size="16" class="saved" col>
        <Saved data={editorValue} @select={(e)=>editorValue=e.detail}/>
      </Pane>
    {/if}
  </Pane>
  {#if online}
    <Pane row class="editor" size="11">
      <Pane>
        <Editor mode={editorMode} :value={editorValue}/>
      </Pane>
      <Pane size="16" col>
        <Pane>
            <ModeSwitcher :mode={editorMode} />
        </Pane>
        <Pane class="text-center">
          <Button 
            primary 
            iconRight={mdiSend} 
            disabled={!editorValue.length}
            loading={sending}
            @click={send}
          >Send</Button>
        </Pane>
      </Pane>
    </Pane>
  {/if}
{:else}

{/if}


<style>
  .top{
    border-bottom: var(--border);
  }
  .requests{
    flex-grow: 1;
    flex-basis:0;
    overflow-y: scroll;
  }
  .request{
    margin: 2rem;
  }
  .status{
    margin: 1rem;
    font-weight: bold;
  }
  span{
    color: var(--color-neutral);
    font-weight: normal;
  }
  .saved{
    border-left: var(--border);
  }
  .editor{
    border-top: var(--border);
    overflow: hidden;
  }
</style>